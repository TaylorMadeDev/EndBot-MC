import React, { useMemo, useState, useEffect } from 'react';
import { shodanSearch, getShodanInfo, listMonitoredServers, addMonitoredServer, deleteMonitoredServer } from '../utils/api';
import CustomSelect from '../components/CustomSelect';
import '../styles/dashboard.css';
import '../styles/pentester.css';

export default function Pentester() {
  const [activeTab, setActiveTab] = useState('search'); // 'search' or 'monitored'
  const [searchQuery, setSearchQuery] = useState('');
  const [searchVersion, setSearchVersion] = useState('');
  const [country, setCountry] = useState('');
  const [org, setOrg] = useState('');
  const [port, setPort] = useState('');
  const [includeFacets, setIncludeFacets] = useState(true);
  const [autoSave, setAutoSave] = useState(false);
  const [searchResults, setSearchResults] = useState([]);
  const [searching, setSearching] = useState(false);
  const [searchError, setSearchError] = useState(null);
  const [currentPage, setCurrentPage] = useState(1);
  const [totalResults, setTotalResults] = useState(0);
  const [shodanInfo, setShodanInfo] = useState(null);
  
  const [monitoredServers, setMonitoredServers] = useState([]);
  const [loadingServers, setLoadingServers] = useState(false);
  const [savingAll, setSavingAll] = useState(false);

  const versionOptions = useMemo(() => {
    const list = [
      '1.21.8','1.21.7','1.21.6','1.21.5','1.21.4','1.21.3','1.21.2','1.21.1','1.21',
      '1.20.6','1.20.5','1.20.4','1.20.3','1.20.2','1.20.1','1.20',
      '1.19.4','1.19.3','1.19.2','1.19.1','1.19',
      '1.18.2','1.18.1','1.18',
      '1.17.1','1.17',
      '1.16.5','1.16.4','1.16.3','1.16.2','1.16.1','1.16',
      '1.12.2','1.8.9'
    ];
    return list.map(v => ({ value: v, label: v }));
  }, []);

  // Load Shodan API info on mount
  useEffect(() => {
    loadShodanInfo();
    loadMonitoredServers();
  }, []);

  const loadShodanInfo = async () => {
    try {
      const info = await getShodanInfo();
      setShodanInfo(info);
    } catch (err) {
      console.error('Failed to load Shodan info:', err);
    }
  };

  const loadMonitoredServers = async () => {
    try {
      setLoadingServers(true);
      const data = await listMonitoredServers();
      setMonitoredServers(data.servers || []);
    } catch (err) {
      console.error('Failed to load monitored servers:', err);
    } finally {
      setLoadingServers(false);
    }
  };

  const handleSearch = async (page = 1) => {
    try {
      setSearching(true);
      setSearchError(null);

      // Build additional query
      const extraFilters = [];
      if (country) extraFilters.push(`country:${country.trim()}`);
      if (org) extraFilters.push(`org:\"${org.trim()}\"`);
      if (port) extraFilters.push(`port:${parseInt(port,10)}`);
      const fullQuery = [searchQuery || 'minecraft', ...extraFilters].join(' ').trim();

      const facets = includeFacets ? 'port:100,country:100,org:100' : undefined;

      const data = await shodanSearch({
        query: fullQuery,
        version: searchVersion || undefined,
        page,
        facets
      });

      setSearchResults(data.servers || []);
      setTotalResults(data.total || 0);
      setCurrentPage(page);

      if (autoSave && (data.servers || []).length > 0) {
        await handleSaveAll(data.servers || []);
      }
    } catch (err) {
      console.error('Search failed:', err);
      setSearchError(err.message || 'Failed to search Shodan');
      setSearchResults([]);
    } finally {
      setSearching(false);
    }
  };

  const handleSaveAll = async (servers = searchResults) => {
    if (!servers || servers.length === 0) return;
    if (!autoSave) {
      const ok = window.confirm(`Add ${servers.length} servers to monitoring? Duplicates will be skipped.`);
      if (!ok) return;
    }
    setSavingAll(true);
    let added = 0, skipped = 0, failed = 0;
    for (const s of servers) {
      try {
        await addMonitoredServer({
          host: s.host,
          port: s.port,
          version: s.version,
          motd: s.motd,
          playerCount: s.playerCount,
          maxPlayers: s.maxPlayers,
          metadata: { country: s.country, countryCode: s.countryCode, org: s.org, lastUpdate: s.lastUpdate }
        });
        added++;
      } catch (e) {
        if (String(e.message || '').toLowerCase().includes('already')) skipped++; else failed++;
      }
    }
    await loadMonitoredServers();
    setSavingAll(false);
    if (!autoSave) alert(`Saved ${added}, skipped ${skipped}, failed ${failed}.`);
  };

  const handleAddToMonitor = async (server) => {
    try {
      await addMonitoredServer({
        host: server.host,
        port: server.port,
        version: server.version,
        motd: server.motd,
        playerCount: server.playerCount,
        maxPlayers: server.maxPlayers,
        metadata: {
          country: server.country,
          countryCode: server.countryCode,
          org: server.org,
          lastUpdate: server.lastUpdate
        }
      });

      // Reload monitored servers
      await loadMonitoredServers();
      
      // Show success feedback
      alert(`Added ${server.host}:${server.port} to monitoring!`);
    } catch (err) {
      if (err.message.includes('already')) {
        alert('This server is already being monitored');
      } else {
        alert('Failed to add server: ' + err.message);
      }
    }
  };

  const handleRemoveFromMonitor = async (serverId) => {
    if (!window.confirm('Remove this server from monitoring?')) return;
    
    try {
      await deleteMonitoredServer(serverId);
      await loadMonitoredServers();
    } catch (err) {
      alert('Failed to remove server: ' + err.message);
    }
  };

  return (
    <div className="dashboard-page">
      <div className="page-header">
        <div>
          <h1 className="page-title">
            <i className="fas fa-shield-alt"></i> Pentester
          </h1>
          <p className="page-subtitle">Discover and monitor Minecraft servers</p>
        </div>
        {shodanInfo && (
          <div className="current-task-card">
            <div className="ct-header">
              <i className="fas fa-database"></i>
              <span>Shodan API</span>
            </div>
            <div className="ct-body">
              <div className="ct-name">{shodanInfo.plan || 'Free'} Plan</div>
              <div className="ct-meta">
                <span>{shodanInfo.credits || 0} credits remaining</span>
              </div>
            </div>
          </div>
        )}
      </div>

      {/* Tabs */}
      <div style={{ display: 'flex', gap: '1rem', marginBottom: '2rem', borderBottom: '2px solid rgba(255,255,255,0.1)' }}>
        <button
          className={`tab-button ${activeTab === 'search' ? 'active' : ''}`}
          onClick={() => setActiveTab('search')}
          style={{
            padding: '0.75rem 1.5rem',
            background: activeTab === 'search' ? 'rgba(99,102,241,0.2)' : 'transparent',
            border: 'none',
            borderBottom: activeTab === 'search' ? '2px solid var(--primary)' : '2px solid transparent',
            color: activeTab === 'search' ? 'var(--primary)' : 'var(--text-muted)',
            fontWeight: '600',
            cursor: 'pointer',
            transition: 'all 0.2s',
            marginBottom: '-2px'
          }}
        >
          <i className="fas fa-search"></i> Shodan Search
        </button>
        <button
          className={`tab-button ${activeTab === 'monitored' ? 'active' : ''}`}
          onClick={() => setActiveTab('monitored')}
          style={{
            padding: '0.75rem 1.5rem',
            background: activeTab === 'monitored' ? 'rgba(99,102,241,0.2)' : 'transparent',
            border: 'none',
            borderBottom: activeTab === 'monitored' ? '2px solid var(--primary)' : '2px solid transparent',
            color: activeTab === 'monitored' ? 'var(--primary)' : 'var(--text-muted)',
            fontWeight: '600',
            cursor: 'pointer',
            transition: 'all 0.2s',
            marginBottom: '-2px'
          }}
        >
          <i className="fas fa-eye"></i> Monitored Servers ({monitoredServers.length})
        </button>
      </div>

      {/* Search Tab */}
      {activeTab === 'search' && (
        <div className="dashboard-grid" style={{ gridTemplateColumns: '1fr', gap: '1.5rem' }}>
          <div className="dashboard-section">
            <div className="section-header">
              <h2><i className="fas fa-search"></i> Search Minecraft Servers</h2>
            </div>
            
            <form
              onSubmit={(e) => {
                e.preventDefault();
                handleSearch(1);
              }}
              style={{ display: 'flex', flexDirection: 'column', gap: '1rem' }}
            >
              <div className="grid cols-2">
                <div>
                  <label style={{ display: 'block', fontSize: '0.8rem', fontWeight: '600', textTransform: 'uppercase', letterSpacing: '0.5px', marginBottom: '0.5rem', color: 'var(--text-muted)' }}>
                    Additional Query (optional)
                  </label>
                  <input
                    type="text"
                    value={searchQuery}
                    onChange={(e) => setSearchQuery(e.target.value)}
                    placeholder="e.g., country:US, org:Amazon"
                  />
                  <p style={{ fontSize: '0.75rem', color: 'var(--text-muted)', marginTop: '0.25rem' }}>
                    Leave empty to search all Minecraft servers
                  </p>
                </div>

                <div>
                  <label style={{ display: 'block', fontSize: '0.8rem', fontWeight: '600', textTransform: 'uppercase', letterSpacing: '0.5px', marginBottom: '0.5rem', color: 'var(--text-muted)' }}>
                    Minecraft Version (searchable)
                  </label>
                  <CustomSelect
                    value={searchVersion}
                    onChange={setSearchVersion}
                    options={[{ value: '', label: 'Any version' }, ...versionOptions]}
                    placeholder="Type to search versions..."
                    searchable
                    searchPlaceholder="Type a version..."
                  />
                  <p style={{ fontSize: '0.75rem', color: 'var(--text-muted)', marginTop: '0.25rem' }}>Filter by specific Minecraft version</p>
                </div>
              </div>

              {/* Advanced Filters */}
              <div className="grid cols-3">
                <div>
                  <label style={{ display: 'block', fontSize: '0.8rem', fontWeight: '600', textTransform: 'uppercase', letterSpacing: '0.5px', marginBottom: '0.5rem', color: 'var(--text-muted)' }}>
                    Country Code
                  </label>
                  <input type="text" value={country} onChange={(e) => setCountry(e.target.value.toUpperCase())} placeholder="US" />
                </div>
                <div>
                  <label style={{ display: 'block', fontSize: '0.8rem', fontWeight: '600', textTransform: 'uppercase', letterSpacing: '0.5px', marginBottom: '0.5rem', color: 'var(--text-muted)' }}>
                    Organization
                  </label>
                  <input type="text" value={org} onChange={(e) => setOrg(e.target.value)} placeholder="OVH, Amazon, Hetzner..." />
                </div>
                <div>
                  <label style={{ display: 'block', fontSize: '0.8rem', fontWeight: '600', textTransform: 'uppercase', letterSpacing: '0.5px', marginBottom: '0.5rem', color: 'var(--text-muted)' }}>
                    Port
                  </label>
                  <div className="input-wrap">
                    <i className="fas fa-plug input-icon"></i>
                    <input type="number" value={port} onChange={(e) => setPort(e.target.value)} placeholder="25565" />
                    {port && (
                      <button type="button" className="input-clear" onClick={() => setPort('')} title="Clear">
                        <i className="fas fa-times"></i>
                      </button>
                    )}
                  </div>
                </div>
              </div>

              <div style={{ display: 'flex', gap: '1rem', alignItems: 'center', flexWrap: 'wrap' }}>
                <label className="checkbox-control" title="Use Shodan facets to group by port/country/org">
                  <input
                    className="checkbox-input"
                    type="checkbox"
                    checked={includeFacets}
                    onChange={(e) => setIncludeFacets(e.target.checked)}
                  />
                  <span className="checkbox-box"><i className="fas fa-check check-icon"/></span>
                  <span className="checkbox-label">Include facets (port, country, org)</span>
                </label>

                <label className="checkbox-control" title="Automatically add results to your monitored list">
                  <input
                    className="checkbox-input"
                    type="checkbox"
                    checked={autoSave}
                    onChange={(e) => setAutoSave(e.target.checked)}
                  />
                  <span className="checkbox-box"><i className="fas fa-check check-icon"/></span>
                  <span className="checkbox-label">Auto-save results to monitoring</span>
                </label>
              </div>

              <button
                type="submit"
                disabled={searching}
                className="btn primary"
                style={{ alignSelf: 'flex-start' }}
              >
                <i className={`fas ${searching ? 'fa-spinner fa-spin' : 'fa-search'}`}></i>
                {searching ? 'Searching...' : 'Search Shodan'}
              </button>

              {!searching && searchResults.length > 0 && (
                <button
                  type="button"
                  disabled={savingAll}
                  onClick={() => handleSaveAll()}
                  className="btn"
                  style={{ alignSelf: 'flex-start', marginLeft: '0.5rem', background: 'rgba(16,185,129,0.1)', color: '#10b981' }}
                >
                  <i className={`fas ${savingAll ? 'fa-spinner fa-spin' : 'fa-save'}`}></i>
                  {savingAll ? 'Saving All...' : 'Save All Results'}
                </button>
              )}
            </form>

            {searchError && (
              <div style={{ marginTop: '1rem', padding: '1rem', background: 'rgba(239,68,68,0.1)', border: '1px solid rgba(239,68,68,0.3)', borderRadius: '12px', color: '#f87171' }}>
                <i className="fas fa-exclamation-triangle"></i> {searchError}
              </div>
            )}
          </div>

          {/* Search Results */}
          {searchResults.length > 0 && (
            <div className="dashboard-section">
              <div className="section-header">
                <h2><i className="fas fa-server"></i> Search Results</h2>
                <span className="item-count">
                  {totalResults.toLocaleString()} total results (page {currentPage})
                </span>
              </div>

              <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(360px, 1fr))', gap: '1.1rem' }}>
                {searchResults.map((server, idx) => (
                  <div
                    key={idx}
                    className="bot-item"
                    style={{
                      display: 'flex', flexDirection: 'column', gap: '0.9rem', padding: '1.1rem', cursor: 'default',
                      background: 'linear-gradient(145deg, rgba(18,14,32,0.9), rgba(28,8,48,0.85))',
                      border: '1px solid rgba(139,92,246,0.18)',
                      borderRadius: '14px',
                      boxShadow: '0 10px 24px rgba(0,0,0,0.35), inset 0 0 0 1px rgba(255,255,255,0.03)',
                      transition: 'transform .15s ease, box-shadow .2s ease, border-color .2s ease'
                    }}
                    onMouseEnter={(e) => { e.currentTarget.style.transform = 'translateY(-2px)'; e.currentTarget.style.borderColor = 'rgba(139,92,246,0.35)'; }}
                    onMouseLeave={(e) => { e.currentTarget.style.transform = 'translateY(0)'; e.currentTarget.style.borderColor = 'rgba(139,92,246,0.18)'; }}
                  >
                    <div style={{ display: 'flex', alignItems: 'center', gap: '0.9rem' }}>
                      <div style={{
                        width: '44px', height: '44px', borderRadius: '12px',
                        background: 'linear-gradient(135deg, rgba(99,102,241,0.9), rgba(236,72,153,0.9))',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        fontSize: '1.2rem', color: 'white', boxShadow: '0 6px 18px rgba(139,92,246,0.35)'
                      }}>
                        <i className="fas fa-server"></i>
                      </div>
                      <div style={{ flex: 1, minWidth: 0 }}>
                        <div style={{ fontWeight: 700, fontSize: '1.05rem', marginBottom: '0.25rem', overflow: 'hidden', textOverflow: 'ellipsis' }}>
                          {server.host}:{server.port}
                        </div>
                        <div style={{ display: 'flex', flexWrap: 'wrap', gap: '0.4rem' }}>
                          <span style={{ fontSize: '0.72rem', padding: '0.25rem 0.5rem', borderRadius: 999, background: 'rgba(99,102,241,0.15)', color: 'var(--primary)', border: '1px solid rgba(99,102,241,0.35)' }}>v{server.version}</span>
                          <span style={{ fontSize: '0.72rem', padding: '0.25rem 0.5rem', borderRadius: 999, background: 'rgba(236,72,153,0.12)', color: '#ec4899', border: '1px solid rgba(236,72,153,0.3)' }}>{server.countryCode}</span>
                          {server.playerCount !== null && (
                            <span style={{ fontSize: '0.72rem', padding: '0.25rem 0.5rem', borderRadius: 999, background: 'rgba(16,185,129,0.12)', color: '#10b981', border: '1px solid rgba(16,185,129,0.3)' }}>
                              {server.playerCount}/{server.maxPlayers} players
                            </span>
                          )}
                        </div>
                      </div>
                    </div>

                    <div style={{ padding: '0.75rem', background: 'rgba(0,0,0,0.25)', borderRadius: '10px', fontSize: '0.85rem', color: 'var(--text-muted)', fontFamily: 'monospace', border: '1px solid rgba(255,255,255,0.06)' }}>
                      {server.motd || 'No MOTD'}
                    </div>

                    <div style={{ fontSize: '0.78rem', color: 'var(--text-muted)', display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '0.4rem 1rem' }}>
                      <div><i className="fas fa-flag"></i> {server.country}</div>
                      <div><i className="fas fa-building"></i> {server.org}</div>
                      <div><i className="fas fa-clock"></i> {new Date(server.lastUpdate).toLocaleDateString()}</div>
                    </div>

                    <div style={{ display: 'flex', gap: '0.6rem' }}>
                      <button className="btn primary" onClick={() => handleAddToMonitor(server)} style={{ flex: 1 }}>
                        <i className="fas fa-plus-circle"></i> Add to Monitor
                      </button>
                      <button className="btn" disabled title="Whitelist & Plugin checker coming soon" style={{ background: 'rgba(59,130,246,0.12)', color: '#60a5fa' }}>
                        <i className="fas fa-plug"></i>
                      </button>
                    </div>
                  </div>
                ))}
              </div>

              {/* Pagination */}
              {totalResults > 100 && (
                <div style={{ display: 'flex', gap: '0.5rem', justifyContent: 'center', marginTop: '1.5rem' }}>
                  <button
                    className="btn"
                    onClick={() => handleSearch(currentPage - 1)}
                    disabled={currentPage === 1 || searching}
                  >
                    <i className="fas fa-chevron-left"></i> Previous
                  </button>
                  <span style={{ padding: '0.5rem 1rem', display: 'flex', alignItems: 'center', color: 'var(--text-muted)' }}>
                    Page {currentPage} / {Math.ceil(totalResults / 100)}
                  </span>
                  <button
                    className="btn"
                    onClick={() => handleSearch(currentPage + 1)}
                    disabled={searchResults.length < 100 || searching}
                  >
                    Next <i className="fas fa-chevron-right"></i>
                  </button>
                </div>
              )}
            </div>
          )}
        </div>
      )}

      {/* Monitored Servers Tab */}
      {activeTab === 'monitored' && (
        <div className="dashboard-section">
          <div className="section-header">
            <h2><i className="fas fa-eye"></i> Monitored Servers</h2>
            <span className="item-count">{monitoredServers.length} servers</span>
          </div>

          {loadingServers ? (
            <div className="loading-container">
              <div className="loading-spinner"></div>
              <p className="loading-text">Loading servers...</p>
            </div>
          ) : monitoredServers.length === 0 ? (
            <div className="empty-state">
              <i className="fas fa-server empty-icon"></i>
              <h3 className="empty-title">No Monitored Servers</h3>
              <p className="empty-description">Search for servers and add them to monitoring</p>
              <button className="btn primary" onClick={() => setActiveTab('search')} style={{ marginTop: '1rem' }}>
                <i className="fas fa-search"></i> Search Servers
              </button>
            </div>
          ) : (
            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(350px, 1fr))', gap: '1rem' }}>
              {monitoredServers.map((server) => (
                <div
                  key={server.id}
                  className="bot-item"
                  style={{
                    display: 'flex',
                    flexDirection: 'column',
                    gap: '1rem',
                    padding: '1.25rem',
                    background: 'rgba(255,255,255,0.02)',
                    border: '1px solid rgba(255,255,255,0.1)',
                    borderRadius: '12px'
                  }}
                >
                  <div style={{ display: 'flex', alignItems: 'center', gap: '1rem' }}>
                    <div style={{
                      width: '40px',
                      height: '40px',
                      borderRadius: '10px',
                      background: 'linear-gradient(135deg, var(--success), var(--nebula-cyan))',
                      display: 'flex',
                      alignItems: 'center',
                      justifyContent: 'center',
                      fontSize: '1.25rem'
                    }}>
                      <i className="fas fa-eye"></i>
                    </div>
                    <div style={{ flex: 1 }}>
                      <div style={{ fontWeight: '600', fontSize: '1rem', marginBottom: '0.25rem' }}>
                        {server.host}:{server.port}
                      </div>
                      <div style={{ fontSize: '0.75rem', color: 'var(--text-muted)', display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                        {server.version && <span>v{server.version}</span>}
                        {server.player_count !== null && (
                          <>
                            <span>â€¢</span>
                            <span>{server.player_count}/{server.max_players} players</span>
                          </>
                        )}
                      </div>
                    </div>
                  </div>

                  {server.motd && (
                    <div style={{ padding: '0.75rem', background: 'rgba(0,0,0,0.2)', borderRadius: '8px', fontSize: '0.85rem', color: 'var(--text-muted)', fontFamily: 'monospace' }}>
                      {server.motd}
                    </div>
                  )}

                  <div style={{ fontSize: '0.75rem', color: 'var(--text-muted)' }}>
                    <div>Added: {new Date(server.added_at).toLocaleDateString()}</div>
                    {server.last_checked && (
                      <div>Last checked: {new Date(server.last_checked).toLocaleDateString()}</div>
                    )}
                    {(() => {
                      if (!server.metadata) return null;
                      const meta = typeof server.metadata === 'string'
                        ? (() => { try { return JSON.parse(server.metadata); } catch { return null; } })()
                        : server.metadata;
                      if (meta && meta.country) {
                        return <div>Country: {meta.country}</div>;
                      }
                      return null;
                    })()}
                  </div>

                  <div style={{ display: 'flex', gap: '0.5rem' }}>
                    <button className="btn" style={{ flex: 1 }}>
                      <i className="fas fa-play"></i> Start Actions
                    </button>
                    <button
                      className="btn"
                      onClick={() => handleRemoveFromMonitor(server.id)}
                      style={{ background: 'rgba(239,68,68,0.1)', color: '#ef4444' }}
                    >
                      <i className="fas fa-trash"></i>
                    </button>
                  </div>
                </div>
              ))}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
